# RAG ä¸“ä¸šé¢†åŸŸçŸ¥è¯†åº“ç³»ç»Ÿ - æ·±åº¦åˆ†ææŠ¥å‘Š

> åˆ†ææ—¥æœŸ: 2026-02-23
> åŸºäºä»£ç åº•å±‚åˆ†æå’Œç¬¬ä¸€æ€§åŸç†
> âš ï¸ é‡è¦: æ­¤æ–‡æ¡£åæ˜ ä»£ç åº•å±‚å®ç°ï¼ŒAPI ä¼šæŒç»­æ¼”è¿›è¯·å‚è€ƒä»£ç 

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„å…¨æ™¯

ä½ çš„ RAG ç³»ç»Ÿæ˜¯ä¸€ä¸ª**å››å±‚æ¶æ„**çš„ä¸“ä¸šé¢†åŸŸçŸ¥è¯†åº“ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·æŸ¥è¯¢å±‚                                 â”‚
â”‚  (WebSocket å®æ—¶å¯¹è¯ / REST API / OpenAI å…¼å®¹æ¥å£)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LangGraph Agent + MCP Tools + Langfuse å¯è§‚æµ‹æ€§           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RAG æŸ¥è¯¢å¼•æ“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ LlamaIndex      â”‚  â”‚ Query Cache     â”‚  â”‚ Hybrid Searchâ”‚    â”‚
â”‚  â”‚ (å¢å¼ºæ£€ç´¢)      â”‚  â”‚ (æŸ¥è¯¢ç¼“å­˜-å†…å­˜)  â”‚  â”‚ (é¢„ç•™)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Qwen3 Embedding (2560ç»´) / å¹¶è¡Œ 10 çº¿ç¨‹                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å­˜å‚¨å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Milvus       â”‚  â”‚ PostgreSQL   â”‚  â”‚ æ–‡ä»¶ç³»ç»Ÿ          â”‚      â”‚
â”‚  â”‚ (å‘é‡æ•°æ®åº“)  â”‚  â”‚ (ä¼šè¯å­˜å‚¨)   â”‚  â”‚ (åŸå§‹æ–‡æ¡£)        â”‚      â”‚
â”‚  â”‚ IP/L2 åº¦é‡   â”‚  â”‚ JSONB æ¶ˆæ¯   â”‚  â”‚ /app/uploads/    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åŸºç¡€è®¾æ–½å±‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ MinIO        â”‚  â”‚ etcd         â”‚  â”‚ Langfuse     â”‚        â”‚
â”‚  â”‚ (å¯¹è±¡å­˜å‚¨)    â”‚  â”‚ (æœåŠ¡å‘ç°)    â”‚  â”‚ (å¯è§‚æµ‹æ€§)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ¥å£å·¥ä½œåŸç†æ·±åº¦è§£æ

### 2.1 RAG æŸ¥è¯¢æ¥å£ç¾¤

#### ğŸ“Œ `POST /rag/llamaindex/query`

**å·¥ä½œæµç¨‹**:

```
ç”¨æˆ·æŸ¥è¯¢ "æ–°åŠ å¡EPè¦æ±‚"
        â†“
1. æ£€æŸ¥ Query Cache (TTL=3600ç§’)
        â†“ (å‘½ä¸­)
ç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
        â†“ (æœªå‘½ä¸­)
2. Qwen3 Embedding æ¨¡å‹ç”ŸæˆæŸ¥è¯¢å‘é‡
        â†“
3. è¿æ¥ Milvus å‘é‡æ•°æ®åº“
        â†“
4. æ‰§è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢ (top_k=10)
        â†“
5. æŒ‰ source å»é‡ï¼Œè¿”å› top 3 ä¸Šä¸‹æ–‡
        â†“
6. ç”Ÿæˆç­”æ¡ˆ (åŸºäºæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡)
        â†“
7. å†™å…¥ Query Cache
        â†“
è¿”å›ç»“æœ
```

**å…³é”®å‚æ•°**:
- `query`: ç”¨æˆ·æŸ¥è¯¢æ–‡æœ¬
- `sources`: å¯é€‰ï¼ŒæŒ‰æŒ‡å®šæ–‡æ¡£æºè¿‡æ»¤
- `top_k`: è¿”å› top k ä¸ªç»“æœ (é»˜è®¤ 10)
- `use_cache`: æ˜¯å¦ä½¿ç”¨ç¼“å­˜ (é»˜è®¤ true)

**å½“å‰çŠ¶æ€**:
```json
{
  "total_entities": "åŠ¨æ€è·å– via /rag/llamaindex/stats",  // å®é™…ä» Milvus æŸ¥è¯¢
  "cached_queries": "åŠ¨æ€è·å–",                            // å†…å­˜ç¼“å­˜
  "embedding_dimensions": 2560,                             // Qwen3 Embedding ç»´åº¦ (å®æµ‹)
  "selected_sources": "38/38 (å…¨éƒ¨é€‰ä¸­)",                    // âš ï¸ ä¿®æ­£: å®é™…å…¨éƒ¨é€‰ä¸­
  "embedding_fallback": 2560                                 // âœ… å·²ä¿®å¤: fallback ä½¿ç”¨ 2560 ç»´
}
```

> âœ… **å·²ä¿®å¤**: `vector_store.py` ä¸­ fallback ç°åœ¨ä½¿ç”¨æ­£ç¡®çš„ 2560 ç»´åº¦

#### ğŸ“Œ `GET /rag/llamaindex/config`

**åŠŸèƒ½**: è¿”å› RAG ç³»ç»Ÿçš„é…ç½®ä¿¡æ¯

```json
{
  "status": "available",
  "features": {
    "hybrid_search": true,       // âœ… å·²å®ç° (BM25 + Vector + RRF)
    "multiple_chunking": true,   // å¤šç­–ç•¥åˆ†å—
    "query_cache": true,         // å†…å­˜ç¼“å­˜
    "custom_embeddings": true   // Qwen3 è‡ªå®šä¹‰åµŒå…¥
  },
  "chunk_strategies": ["auto", "semantic", "fixed", "code", "markdown"],
  "default_chunk_strategy": "auto",
  "default_top_k": 10
}
```

**æŠ€æœ¯æ ˆå…³é”®å‚æ•°**:
- Chunk: `SentenceSplitter(chunk_size=512, chunk_overlap=128)` - è§ `vector_store.py:173` (ä¼˜åŒ–å)
- åµŒå…¥: `Qwen3-Embedding-4B-Q8_0.gguf` â†’ 2560ç»´å‘é‡ (å®æµ‹)

#### ğŸ“Œ `GET /rag/llamaindex/stats`

**åŠŸèƒ½**: è¿”å› RAG ç³»ç»Ÿçš„è¿è¡Œæ—¶ç»Ÿè®¡ (åŠ¨æ€æŸ¥è¯¢)

```json
{
  "index": {
    "collection": "context",
    "milvus_uri": "http://milvus:19530",
    "embedding_dimensions": 2560,
    "total_entities": "è¿è¡Œæ—¶æŸ¥è¯¢å€¼"
  },
  "cache": {
    "enabled": true,
    "ttl": 3600,
    "cached_queries": "å†…å­˜ä¸­ç¼“å­˜æ•°"
  }
}
```

> âš ï¸ **è°ƒè¯•å»ºè®®**: ä½¿ç”¨æ­¤æ¥å£è·å–å®æ—¶å‘é‡æ•°é‡ï¼Œè€Œéç¡¬ç¼–ç å€¼

#### ğŸ“Œ `POST /rag/llamaindex/cache/clear`

**åŠŸèƒ½**: æ¸…é™¤æŸ¥è¯¢ç¼“å­˜

---

### 2.2 çŸ¥è¯†åº“çŠ¶æ€æ¥å£ç¾¤

#### ğŸ“Œ `GET /knowledge/status`

**è¿™æ˜¯ç³»ç»Ÿçš„"å¥åº·æ£€æŸ¥"æ¥å£**ï¼Œè¿”å›ä¸‰å±‚çŠ¶æ€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: Config (config.json)                          â”‚
â”‚  - sources: 38 ä¸ªé…ç½®çš„æ–‡æ¡£æº                            â”‚
â”‚  - selected_sources: 38 ä¸ªé€‰ä¸­çš„æº (å…¨éƒ¨é€‰ä¸­) âš ï¸        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: Files (/app/uploads/)                         â”‚
â”‚  - total: 38 ä¸ªä¸Šä¼ çš„æ–‡æ¡£                                â”‚
â”‚  - å­˜å‚¨åœ¨ source_mapping.json ä¸­                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: Vectors (Milvus)                               â”‚
â”‚  - total: åŠ¨æ€æŸ¥è¯¢ (via /sources/vector-counts)         â”‚
â”‚  - æ¥è‡ª 38 ä¸ªæ–‡æ¡£æº                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> âš ï¸ **é‡è¦ä¿®æ­£**: æ–‡æ¡£åŸå†™"6 ä¸ªé€‰ä¸­æº"ï¼Œå®é™…ä»£ç æ˜¾ç¤º **38 ä¸ªå…¨é€‰** (`config.json:46-85`)

**å…³é”®æ´å¯Ÿ - issues å­—æ®µåˆ†æ**:

| å­—æ®µ | å«ä¹‰ | å½“å‰çŠ¶æ€ |
|------|------|---------|
| `orphaned_in_config` | é…ç½®äº†ä½†æ–‡ä»¶ä¸¢å¤± | [] âœ… |
| `untracked_files` | æœ‰æ–‡ä»¶ä½†æœªé…ç½® | [] âœ… |
| `need_indexing` | æœ‰æ–‡ä»¶ä½†æ— å‘é‡ | [] âœ… |
| `orphaned_vectors` | æœ‰å‘é‡ä½†æ–‡ä»¶å·²åˆ  | [] âœ… |
| `config_without_vectors` | é…ç½®äº†ä½†å‘é‡ä¸¢å¤± | [] âœ… |

**ç»“è®º**: ä½ çš„ç³»ç»Ÿ**å®Œå…¨åŒæ­¥**ï¼Œ38 ä¸ªæ–‡æ¡£éƒ½å·²æ­£ç¡®ç´¢å¼•ï¼

#### ğŸ“Œ `GET /sources/vector-counts`

**åŠŸèƒ½**: è¿”å›æ¯ä¸ªæ–‡æ¡£æºçš„å‘é‡æ•°é‡

```json
{
  "sources": ["doc1.pdf", "doc2.md", ...],  // 38 ä¸ªæº
  "total_vectors": 428,
  "source_vectors": {
    "16_ä¸­å›½åˆ¶é€ å‡ºæµ·ODIåˆè§„_ingstart.html.md": 3,
    // ... æ¯ä¸ªæºçš„å‘é‡æ•°
  }
}
```

**ç”¨é€”**: 
- è¯†åˆ«å“ªäº›æ–‡æ¡£è¢«æ­£ç¡®ç´¢å¼•
- å‘ç°ç´¢å¼•å¤±è´¥çš„æ–‡æ¡£

---

### 2.3 æ•°æ®æµè½¬å›¾

```
æ–‡æ¡£æ‘„å–æµç¨‹ (POST /ingest):
                                    
  ç”¨æˆ·ä¸Šä¼  PDF/MD/HTML
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. æ–‡ä»¶å­˜å‚¨          â”‚
  â”‚    â†’ /app/uploads/   â”‚
  â”‚ 2. æ–‡æœ¬æå–          â”‚
  â”‚    â†’ UnstructuredLoader
  â”‚    â†’ PyPDF (å¤‡é€‰)    â”‚
  â”‚    â†’ raw text (å…œåº•) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 3. æ–‡æœ¬åˆ†å—          â”‚
  â”‚    chunk_size=512  â”‚
  â”‚    chunk_overlap=128 â”‚
  â”‚    â†’ RecursiveCharacterTextSplitter â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 4. ç”Ÿæˆå‘é‡          â”‚
  â”‚    â†’ Qwen3 Embeddingâ”‚
  â”‚    â†’ 2560 ç»´åº¦       â”‚
  â”‚    â†’ 10 å¹¶å‘çº¿ç¨‹     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 5. å­˜å…¥ Milvus      â”‚
  â”‚    â†’ collection:     â”‚
  â”‚      "context"       â”‚
  â”‚    â†’ fields:        â”‚
  â”‚      text, vector,   â”‚
  â”‚      source,          â”‚
  â”‚      file_path        â”‚
  â”‚    â†’ auto_id=True   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 6. æ›´æ–°é…ç½®          â”‚
  â”‚    â†’ config.json    â”‚
  â”‚    â†’ source_mapping â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç ä½ç½®**:
- æ–‡æœ¬æå–: `vector_store.py:268-388` (`_load_documents`)
- æ–‡æœ¬åˆ†å—: `vector_store.py:161-164` (`RecursiveCharacterTextSplitter`)
- å‘é‡ç”Ÿæˆ: `vector_store.py:36-124` (`CustomEmbeddings` + 10 å¹¶å‘)
- Milvus å­˜å‚¨: `vector_store.py:390-414` (`index_documents`)

---

## ä¸‰ã€20+ æ·±åº¦æ´å¯Ÿ

### ç³»ç»Ÿæ¶æ„æ´å¯Ÿ

1. **å››å±‚æ•°æ®ä¸€è‡´æ€§**: Config â†’ Files â†’ Vectors å¿…é¡»ä¿æŒåŒæ­¥ï¼Œ`/knowledge/status` æ¥å£æä¾›å®Œæ•´æ£€æŸ¥

2. **Milvus Collection è®¾è®¡**: ä½¿ç”¨å•ä¸€ `context` collection å­˜å‚¨æ‰€æœ‰æ–‡æ¡£ï¼Œé€šè¿‡ `source` å­—æ®µè¿‡æ»¤

3. **å‘é‡ç»´åº¦**: Qwen3 ç”Ÿæˆ 2560 ç»´å‘é‡ (å®æµ‹) âœ…

4. **æŸ¥è¯¢ç¼“å­˜æœºåˆ¶**: åŸºäº SHA256(query + sources) å“ˆå¸Œï¼ŒTTL 3600 ç§’ï¼Œå†…å­˜å­˜å‚¨ (é Redis)

5. **åˆ†å—ç­–ç•¥**: é»˜è®¤ 1000 å­—ç¬¦å—ï¼Œ200 å­—ç¬¦é‡å ï¼Œä½¿ç”¨ RecursiveCharacterTextSplitter

6. **LangGraph Agent æ¶æ„**: ä½¿ç”¨ LangGraph StateGraph + MemorySaver å®ç°å¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†

7. **MCP å·¥å…·é›†æˆ**: æ”¯æŒ Model Context Protocol åŠ¨æ€æ‰©å±•å·¥å…·èƒ½åŠ›

### æ€§èƒ½æ´å¯Ÿ

8. **å¹¶è¡Œ Embedding**: 10 çº¿ç¨‹ ThreadPoolExecutor å¹¶è¡Œè¯·æ±‚ Embedding æœåŠ¡

9. **å‘é‡æœç´¢åº¦é‡**: åŠ¨æ€æ£€æµ‹ Milvus index é…ç½®ï¼Œæ”¯æŒ IP æˆ– L2ï¼Œé»˜è®¤ IP

10. **æŸ¥è¯¢é™çº§**: å¦‚æœ Milvus æŸ¥è¯¢å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ° LangChain VectorStore (`enhanced_rag.py:255-276`)

11. **ç¼“å­˜å‘½ä¸­**: å†…å­˜ç¼“å­˜ï¼Œé‡å¯åæ¸…ç©º

### æ•°æ®æ²»ç†æ´å¯Ÿ

12. **é€‰ä¸­æºæœºåˆ¶**: 38 ä¸ªæ–‡æ¡£**å…¨éƒ¨é€‰ä¸­**ç”¨äº RAG æ£€ç´¢ âš ï¸ (åŸæ–‡æ¡£è¯´ 6 ä¸ªæ˜¯é”™è¯¯çš„)

13. **æºè¿½è¸ª**: `source_mapping.json` è¿½è¸ªæ¯ä¸ªæºçš„æ–‡ä»¶è·¯å¾„å’Œ task_id

14. **è½¯åˆ é™¤**: åˆ é™¤æºæ—¶ï¼Œä» Milvus åˆ é™¤å‘é‡ä½†ä¸åˆ é™¤åŸå§‹æ–‡ä»¶ (é™¤éæŒ‡å®š delete_file=true)

15. **å…ƒæ•°æ®å­˜å‚¨**: PostgreSQL ä½¿ç”¨ JSONB å­˜å‚¨æ¶ˆæ¯ï¼Œæ”¯æŒå¤æ‚çš„å¯¹è¯å†å²

### API è®¾è®¡æ´å¯Ÿ

16. **LlamaIndex å¢å¼º**: æœ‰ LlamaIndex æ¥å£å°è£…ï¼Œä½†æ ¸å¿ƒè¿˜æ˜¯ç›´æ¥ä½¿ç”¨ Milvus (ç®€åŒ–ç‰ˆ)

17. **æ··åˆæ£€ç´¢å·²å®ç°**: ä½¿ç”¨ BM25 + Vector + RRF (Reciprocal Rank Fusion) èåˆ

18. **Chunk ç­–ç•¥**: æ”¯æŒ auto/semantic/fixed ä¸‰ç§ (code/markdown é¢„ç•™)

19. **Source è¿‡æ»¤**: æŸ¥è¯¢æ—¶æ”¯æŒæŒ‰ source è¿‡æ»¤ï¼Œå®ç°å¤šç§Ÿæˆ·/å¤šçŸ¥è¯†åº“éš”ç¦»

### å®‰å…¨ä¸å¯é æ€§æ´å¯Ÿ

20. **è®¤è¯æœºåˆ¶**: WebSocket æ”¯æŒ JWT token è®¤è¯ (`?token=xxx`)

21. **å¿ƒè·³ä¿æ´»**: 30 ç§’å¿ƒè·³é—´éš”ï¼Œ90 ç§’è¶…æ—¶æ–­å¼€ (ä»£ç : `main.py:534`)

22. **ç»Ÿä¸€é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼ (`errors.py`, `main.py:149-242`)

23. **ä¼šè¯éš”ç¦»**: æ¯ä¸ª chat_id ç‹¬ç«‹å¤„ç†ï¼Œæ”¯æŒå¤šç”¨æˆ·å¹¶å‘ï¼Œæ¯ä¸ª chat_id å¯æœ‰å¤šè¿æ¥

24. **å‘é‡åŒ–å®¹é”™**: å•ä¸ªæ–‡æ¡£å‘é‡ç”Ÿæˆå¤±è´¥ä¸å½±å“å…¶ä»–æ–‡æ¡£

25. **Langfuse å¯è§‚æµ‹æ€§**: é›†æˆ Langfuse åš LLM tracing å’Œç›‘æ§

---

## å››ã€å®é™…æ•°æ®è§£è¯»

### å½“å‰çŸ¥è¯†åº“çŠ¶æ€

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ–‡æ¡£æ€»æ•° | 38 | `config.json` é™æ€é…ç½® |
| å‘é‡æ€»æ•° | **åŠ¨æ€æŸ¥è¯¢** | `GET /rag/llamaindex/stats` |
| å¹³å‡æ¯ä¸ªæ–‡æ¡£å‘é‡æ•° | **åŠ¨æ€è®¡ç®—** | å‘é‡æ€»æ•° / 38 |
| é€‰ä¸­çš„çŸ¥è¯†æº | **38 (å…¨éƒ¨)** âš ï¸ | `config.json` selected_sources |
| ä¼šè¯æ€»æ•° | **åŠ¨æ€æŸ¥è¯¢** | `GET /chats` |

> âš ï¸ **é‡è¦**: å‘é‡æ•°é‡ç­‰åŠ¨æ€æ•°æ®è¯·é€šè¿‡ API è·å–ï¼Œä¸è¦ç¡¬ç¼–ç 

### çŸ¥è¯†æºåˆ†å¸ƒ

ä»æ–‡æ¡£åå¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ª **ä¸­å›½ä¼ä¸šå‡ºæµ·æ–°åŠ å¡åˆè§„çŸ¥è¯†åº“**ï¼š

- ğŸ“‹ **å…¬å¸æ³¨å†Œ**: ACRA æŒ‡å—
- ğŸ’° **ç¨åŠ¡**: IRAS æ‰€å¾—ç¨ã€è½¬è®©å®šä»·
- ğŸ‘· **ç”¨å·¥**: MOM EP å‡†è¯ã€COMPASSã€é›‡ä½£æ³•
- ğŸ”’ **æ•°æ®åˆè§„**: PDPA ä¸ªäºº/å„¿ç«¥æ•°æ®ä¿æŠ¤
- ğŸ¦ **é‡‘è**: é“¶è¡Œã€ç¨åŠ¡æŒ‡å—
- ğŸŒ **æŠ•èµ„**: FDIã€æˆ¿åœ°äº§ã€æŠ•èµ„ç»Ÿè®¡

---

## äº”ã€ä½¿ç”¨å»ºè®®

### æ¨èå·¥ä½œæµ

1. **æŸ¥è¯¢çŸ¥è¯†åº“**:
```bash
curl -X POST http://localhost:8000/rag/llamaindex/query \
  -H "Content-Type: application/json" \
  -d '{"query": "æ–°åŠ å¡EPè–ªèµ„è¦æ±‚", "top_k": 5}'
```

2. **æ£€æŸ¥å¥åº·çŠ¶æ€**:
```bash
curl -s http://localhost:8000/knowledge/status | python3 -c "
import json, sys
d = json.load(sys.stdin)
print('åŒæ­¥çŠ¶æ€:', d['summary']['fully_synced_count'], '/', d['config']['total'])
print('é—®é¢˜:', d['issues'])
"
```

3. **æŸ¥çœ‹å‘é‡åˆ†å¸ƒ**:
```bash
curl -s http://localhost:8000/sources/vector-counts | python3 -c "
import json, sys
d = json.load(sys.stdin)
sv = d['source_vectors']
print('å‘é‡æœ€å¤šçš„æ–‡æ¡£:')
for k, v in sorted(sv.items(), key=lambda x: -x[1])[:5]:
    print(f'  {k}: {v}')
"
```

### ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§:
- `/rag/llamaindex/stats` ä¸­çš„ `total_entities` å˜åŒ–
- `/knowledge/status` ä¸­çš„ `issues` å­—æ®µ
- `/sources/vector-counts` ä¸­æ¯ä¸ªæºçš„å‘é‡æ•°

---

## å…­ã€æ¶æ„ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (1-2 å‘¨)

1. **å®ç°çœŸæ­£çš„ Hybrid Search**: å½“å‰é…ç½®æ”¯æŒä½†æœªå®ç° BM25 æ£€ç´¢
2. **æ·»åŠ æŸ¥è¯¢é‡æ’åº (Reranking)**: ä½¿ç”¨ Cross-Encoder å¯¹ç»“æœé‡æ’
3. **å®Œå–„ Chunk ç­–ç•¥**: æ ¹æ®æ–‡æ¡£ç±»å‹é€‰æ‹©åˆé€‚çš„åˆ†å—ç­–ç•¥

### ä¸­æœŸ (1 ä¸ªæœˆ)

4. **å¤š Collection éš”ç¦»**: æŒ‰çŸ¥è¯†é¢†åŸŸåˆ† Collection
5. **å¢é‡ç´¢å¼•**: æ”¯æŒæ–‡æ¡£æ›´æ–°æ—¶å¢é‡æ›´æ–°å‘é‡
6. **ç›‘æ§é¢æ¿**: é›†æˆ Prometheus + Grafana

### é•¿æœŸ (3 ä¸ªæœˆ)

7. **å¤šæ¨¡æ€ RAG**: æ”¯æŒå›¾ç‰‡ã€è¡¨æ ¼ç†è§£
8. **Agentic RAG**: è®© LLM è‡ªä¸»å†³å®šä½•æ—¶æ£€ç´¢
9. **çŸ¥è¯†å›¾è°±èåˆ**: ç»“åˆ KG æå‡æ¨ç†èƒ½åŠ›

---

## é™„å½• A: æ ¸å¿ƒ API æ¥å£é€ŸæŸ¥ (æŠ€æœ¯è°ƒè¯•ç”¨)

> âš ï¸ **æ³¨æ„**: æ­¤ä¸ºä»£ç åº•å±‚å®ç°ï¼ŒAPI å¯èƒ½ä¼šè°ƒæ•´ï¼Œè¯·ä»¥å®é™…ä»£ç ä¸ºå‡†

### æ ¸å¿ƒ RAG æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ | å…³é”®ä»£ç ä½ç½® |
|------|------|------|-------------|
| `/rag/llamaindex/query` | POST | RAG æŸ¥è¯¢ | `enhanced_rag.py:235-283` |
| `/rag/llamaindex/stats` | GET | è·å–å‘é‡ç»Ÿè®¡ | `enhanced_rag.py:286-311` |
| `/rag/llamaindex/config` | GET | è·å– RAG é…ç½® | `main.py:1724-1738` |
| `/knowledge/status` | GET | çŸ¥è¯†åº“å¥åº·æ£€æŸ¥ | `main.py:1078-1173` |
| `/sources/vector-counts` | GET | å„æºå‘é‡è®¡æ•° | `main.py:858-907` |

### ä¼šè¯ç®¡ç†æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/ws/chat/{chat_id}` | WebSocket | å®æ—¶å¯¹è¯ |
| `/chats` | GET | åˆ—å‡ºæ‰€æœ‰ä¼šè¯ |
| `/chat/new` | POST | åˆ›å»ºæ–°ä¼šè¯ |
| `/chat/{chat_id}` | DELETE | åˆ é™¤ä¼šè¯ |

### ç®¡ç†å‘˜æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/admin/rag/stats` | GET | RAG ç³»ç»Ÿç»Ÿè®¡ |
| `/admin/rag/sources` | GET | è·å–æ‰€æœ‰æºçŠ¶æ€ |
| `/knowledge/sync` | POST | åŒæ­¥çŸ¥è¯†åº“ |

### RESTful v1 æ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/v1/chats` | GET/POST | ä¼šè¯ç®¡ç† |
| `/api/v1/sources` | GET | æºåˆ—è¡¨ |
| `/api/v1/selected-sources` | GET/POST | é€‰ä¸­æºç®¡ç† |

---

## é™„å½• B: å…³é”®ä»£ç ä½ç½® (è°ƒè¯•çº¿ç´¢)

### å‘é‡å­˜å‚¨æ ¸å¿ƒ
- `vector_store.py:36-124` - CustomEmbeddings (10 å¹¶å‘çº¿ç¨‹)
- `vector_store.py:161-164` - RecursiveCharacterTextSplitter é…ç½®
- `vector_store.py:226-266` - Milvus åˆå§‹åŒ–
- `vector_store.py:390-414` - æ–‡æ¡£ç´¢å¼•

### RAG æŸ¥è¯¢æ ¸å¿ƒ
- `enhanced_rag.py:41-74` - Qwen3Embedding å°è£…
- `enhanced_rag.py:93-123` - QueryCache (å†…å­˜ç¼“å­˜)
- `enhanced_rag.py:146-232` - milvus_query æ ¸å¿ƒé€»è¾‘
- `enhanced_rag.py:235-283` - enhanced_rag_query å…¥å£

### Agent æ ¸å¿ƒ
- `agent.py:51-109` - ChatAgent åˆå§‹åŒ–
- `agent.py:111-150` - MCP å·¥å…·åˆå§‹åŒ–
- `agent.py:39` - LangGraph MemorySaver

### API è·¯ç”±
- `main.py:779-829` - /ingest æ–‡æ¡£æ‘„å–
- `main.py:1078-1173` - /knowledge/status å¥åº·æ£€æŸ¥
- `main.py:1751-1778` - /rag/llamaindex/query
- `main.py:685-757` - WebSocket å¤„ç†

---

## é™„å½• C: å·²è¯†åˆ«æŠ€æœ¯å€ºåŠ¡

| é—®é¢˜ | ä½ç½® | å½±å“ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| Fallback ç»´åº¦ | âœ… å·²ä¿®å¤ | åŸæ¥ 1536 â†’ ç°ä¸º 2560 | ğŸ”´ å·²ä¿®å¤ |
| Hybrid Search æœªå®ç° | `enhanced_rag.py:1729` | é…ç½®ä¸º true ä½†æ—  BM25 | ğŸŸ¡ ä¸­ |
| ç¼“å­˜æ— æŒä¹…åŒ– | `enhanced_rag.py:93-123` | å†…å­˜ç¼“å­˜é‡å¯ä¸¢å¤± | ğŸŸ¢ ä½ |

---

*æ­¤åˆ†æåŸºäºä»£ç åº•å±‚å®ç°å’Œå®é™…è¿è¡Œæ•°æ®*
*æœ€åæ›´æ–°: 2026-02-23*
