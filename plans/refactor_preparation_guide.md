# DGX Spark åç«¯é¡¹ç›®æ‰‹æœ¯åˆ€å¼å…¨é¢è¯„ä¼°ä¸é‡æ„é“ºå«è®¡åˆ’

> åˆ†ææ—¥æœŸ: 2026-02-27
> é¡¹ç›®: dgx-spark-playbooks/nvidia/multi-agent-chatbot/assets/backend

---

## ä¸€ã€é¡¹ç›®æ•´ä½“ç”»åƒ

### 1.1 é¡¹ç›®è§„æ¨¡ä¸€è§ˆ

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä¼° |
|------|------|------|
| **æ€»æ–‡ä»¶æ•°** | 26+ Python æ–‡ä»¶ | ä¸­å¤§å‹ |
| **main.py è¡Œæ•°** | 2280 è¡Œ | ğŸ”´ ä¸¥é‡è¿‡è½½ |
| **è·¯ç”±ç«¯ç‚¹** | 45+ ä¸ª | ğŸ”´ éœ€æ‹†åˆ† |
| **å…¨å±€å˜é‡** | 5 ä¸ª | ğŸ”´ éœ€ä¾èµ–æ³¨å…¥ |
| **ç›´æ¥ pymilvus å¼•ç”¨** | 7+ å¤„ | ğŸ”´ éœ€å°è£… |

### 1.2 æ ¸å¿ƒæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           main.py (2280è¡Œ)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç”Ÿå‘½å‘¨æœŸç®¡ç† (lifespan) - è¡Œ 94-128                                â”‚
â”‚  2. ä¸­é—´ä»¶é…ç½® (CORS) - è¡Œ 130-141                                      â”‚
â”‚  3. å¼‚å¸¸å¤„ç†å™¨ - è¡Œ 365-450                                            â”‚
â”‚  4. å¥åº·æ£€æŸ¥è·¯ç”± - è¡Œ 154-241                                          â”‚
â”‚  5. WebSocket è·¯ç”± - è¡Œ 953-1025                                      â”‚
â”‚  6. ä¸Šä¼ /æ‘„å–è·¯ç”± - è¡Œ 1028-1101                                       â”‚
â”‚  7. Sources è·¯ç”± - è¡Œ 1116-1295                                        â”‚
â”‚  8. Knowledge è·¯ç”± - è¡Œ 1346-1570                                     â”‚
â”‚  9. Config è·¯ç”± - è¡Œ 1644-1701                                         â”‚
â”‚  10. Chat è·¯ç”± - è¡Œ 1703-1855                                         â”‚
â”‚  11. Collections è·¯ç”± - è¡Œ 1884-1902                                   â”‚
â”‚  12. Test/RAG è·¯ç”± - è¡Œ 1931-1950                                     â”‚
â”‚  13. LlamaIndex è·¯ç”± - è¡Œ 1992-2111                                   â”‚
â”‚  14. Admin è·¯ç”± - è¡Œ 2142-2264                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç‹¬ç«‹æ¨¡å— (è¾ƒå¥½)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… agent.py (600+è¡Œ) - LangGraph çŠ¶æ€æœº                               â”‚
â”‚  âœ… enhanced_rag.py (1400+è¡Œ) - å®Œæ•´ RAG å¼•æ“                         â”‚
â”‚  âœ… vector_store.py (800+è¡Œ) - Milvus å°è£…                            â”‚
â”‚  âœ… postgres_storage.py (500+è¡Œ) - ä¼šè¯å­˜å‚¨                           â”‚
â”‚  âœ… errors.py (250+è¡Œ) - ç»Ÿä¸€é”™è¯¯å¤„ç†                                  â”‚
â”‚  âš ï¸  auth.py (120+è¡Œ) - éœ€æ•´åˆåˆ° middleware                           â”‚
â”‚  âš ï¸  models.py (40+è¡Œ) - éœ€æ‰©å±•ä¸º dto                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ‰‹æœ¯åˆ€å¼é€æ–‡ä»¶åˆ†æ

### 2.1 main.py - æ ¸å¿ƒé—®é¢˜æ‰€åœ¨

**ç°çŠ¶**: 2280 è¡Œï¼Œ45+ è·¯ç”±ç«¯ç‚¹

| åŒºåŸŸ | è¡Œå· | é—®é¢˜ | é‡æ„ç­–ç•¥ |
|------|------|------|----------|
| **åˆå§‹åŒ–** | 69-91 | å…¨å±€å˜é‡å®šä¹‰ | è¿ç§»åˆ° dependencies |
| **Lifespan** | 94-128 | å¯åŠ¨é€»è¾‘ | ä¿æŒæˆ–æ‹†åˆ† |
| **CORS** | 130-141 | ä¸­é—´ä»¶ | è¿ç§»åˆ° middleware |
| **å¼‚å¸¸å¤„ç†** | 365-450 | ç»Ÿä¸€é”™è¯¯ | è¿ç§»åˆ° middleware |
| **Health** | 154-241 | å¥åº·æ£€æŸ¥ | æ‹†åˆ†åˆ° routers/health.py |
| **WebSocket** | 953-1025 | å®æ—¶é€šä¿¡ | æ‹†åˆ†åˆ° routers/websocket.py |
| **Upload** | 1028-1101 | æ–‡ä»¶ä¸Šä¼  | æ‹†åˆ†åˆ° routers/upload.py |
| **Sources** | 1116-1295 | çŸ¥è¯†æº | æ‹†åˆ†åˆ° routers/sources.py |
| **Knowledge** | 1346-1570 | çŸ¥è¯†åº“ | æ‹†åˆ†åˆ° routers/knowledge.py |
| **Config** | 1644-1701 | é…ç½® | æ‹†åˆ†åˆ° routers/config.py |
| **Chat** | 1703-1855 | èŠå¤© | æ‹†åˆ†åˆ° routers/chats.py |
| **Admin** | 2142-2264 | ç®¡ç† | æ‹†åˆ†åˆ° routers/admin.py |

**é‡æ„ç›®æ ‡**: main.py < 500 è¡Œ

### 2.2 agent.py - ç›¸å¯¹å¥åº·

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|------|------|------|
| ä»£ç è¡Œæ•° | ~600 è¡Œ | âœ… åˆç† |
| èŒè´£å•ä¸€æ€§ | LangGraph Agent | âœ… è‰¯å¥½ |
| ä¾èµ–ç®¡ç† | æ„é€ å‡½æ•°æ³¨å…¥ | âš ï¸ å¯ä¼˜åŒ– |
| å¯æµ‹è¯•æ€§ | éƒ¨åˆ†å¯æµ‹è¯• | âš ï¸ éœ€æ”¹è¿› |

**å»ºè®®**: ä¿æŒç°çŠ¶ï¼Œåç»­è€ƒè™‘æå– tool å®šä¹‰

### 2.3 enhanced_rag.py - è§„æ¨¡è¾ƒå¤§ä½†ç»“æ„æ¸…æ™°

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|------|------|------|
| ä»£ç è¡Œæ•° | ~1400 è¡Œ | âš ï¸ è¾ƒå¤§ |
| ç±»/å‡½æ•°æ•°é‡ | 20+ | éœ€æ‹†åˆ† |
| æ¨¡å—åŒ– | æŒ‰åŠŸèƒ½åˆ’åˆ† | âœ… è‰¯å¥½ |

**å†…éƒ¨ç»“æ„**:
```
enhanced_rag.py
â”œâ”€â”€ Qwen3Embedding (41-74)        â†’ embedding.py
â”œâ”€â”€ ChunkStrategy (78-93)         â†’ chunking.py
â”œâ”€â”€ QueryCache (96-123)          â†’ ä¿ç•™
â”œâ”€â”€ RedisQueryCache (142-354)    â†’ ç¼“å­˜æ¨¡å—
â”œâ”€â”€ milvus_query (458-551)       â†’ vector_search.py
â”œâ”€â”€ BM25Indexer (553-667)        â†’ text_search.py
â”œâ”€â”€ Reranker (787-951)           â†’ reranking.py
â”œâ”€â”€ HyDEQueryExpander (953-1037) â†’ query_expansion.py
â”œâ”€â”€ hybrid_search (1105-1350)    â†’ ä¿ç•™æ ¸å¿ƒ
â””â”€â”€ get_stats (1352-1360)        â†’ stats.py
```

**å»ºè®®**: æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹æ¨¡å—

### 2.4 vector_store.py - èŒè´£æ˜ç¡®

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|------|------|------|
| ä»£ç è¡Œæ•° | ~800 è¡Œ | âš ï¸ è¾ƒå¤§ |
| æ ¸å¿ƒç±» | VectorStore, CustomEmbeddings | âœ… æ¸…æ™° |
| Milvus å°è£… | å®Œæ•´ | âœ… å¯å¤ç”¨äº infrastructure |

**å»ºè®®**: è¿ç§»åˆ° infrastructure/milvus_client.py

### 2.5 postgres_storage.py - ä¼˜ç§€è®¾è®¡

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|------|------|------|
| ä»£ç è¡Œæ•° | ~500 è¡Œ | âœ… åˆç† |
| ä¸‰çº§ç¼“å­˜ | æ¶ˆæ¯/å…ƒæ•°æ®/å›¾åƒ | âœ… ç”Ÿäº§çº§ |
| è¿æ¥æ±  | asyncpg | âœ… é«˜æ€§èƒ½ |
| æ‰¹å¤„ç† | åå°å¼‚æ­¥ä¿å­˜ | âœ… ä¼˜ç§€ |

**å»ºè®®**: å¯ç›´æ¥å¤ç”¨äº infrastructure/postgres_client.py

### 2.6 è¾…åŠ©æ–‡ä»¶è¯„ä¼°

| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ | å»ºè®® |
|------|------|------|------|
| **auth.py** | ~120 | âš ï¸ éœ€æ•´åˆ | è¿ç§»åˆ° middleware/auth.py |
| **models.py** | ~40 | âš ï¸ éœ€æ‰©å±• | æ‰©å±•ä¸º dto/ ç›®å½• |
| **config.py** | ~150 | âš ï¸ éœ€æ”¹é€  | ä½¿ç”¨ä¾èµ–æ³¨å…¥ |
| **errors.py** | ~250 | âœ… è‰¯å¥½ | è¿ç§»åˆ° common/errors.py |
| **logger.py** | ~130 | âœ… è‰¯å¥½ | è¿ç§»åˆ° common/logger.py |
| **utils.py** | ~150 | âš ï¸ éœ€åˆ†æ | æ‹†åˆ†åˆ° common/utils.py |
| **prompts.py** | ~100 | âœ… è‰¯å¥½ | ä¿ç•™æˆ–è¿ç§»åˆ° common/ |
| **langfuse_client.py** | ~50 | âœ… è‰¯å¥½ | è¿ç§»åˆ° infrastructure/ |

---

## ä¸‰ã€ç›®å½•ç»“æ„åˆ†æï¼šdto/, middleware/, common/ æ˜¯å¦åˆé€‚ï¼Ÿ

### 3.1 DTO (Data Transfer Object) - âœ… å¼ºçƒˆæ¨è

**å½“å‰é—®é¢˜**: models.py åªæœ‰ 40 è¡Œï¼Œæ‰€æœ‰ Pydantic æ¨¡å‹éƒ½åœ¨ main.py ä¸­å®šä¹‰

**å»ºè®®ç»“æ„**:
```
dto/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ chat_dto.py       # ChatRequest, ChatResponse, ChatMessage
â”œâ”€â”€ rag_dto.py        # QueryRequest, SearchResult, Document
â”œâ”€â”€ knowledge_dto.py  # KnowledgeBase, Collection, Source
â”œâ”€â”€ common_dto.py     # HealthResponse, ErrorResponse, Pagination
â””â”€â”€ admin_dto.py     # AdminStats, ConfigUpdate
```

**ä¸ºä»€ä¹ˆéœ€è¦ DTO**:
- åˆ†ç¦» API è¯·æ±‚/å“åº”ä¸å†…éƒ¨æ•°æ®æ¨¡å‹
- æ”¯æŒ API ç‰ˆæœ¬ç®¡ç†
- ä¾¿äºæ·»åŠ éªŒè¯è§„åˆ™ (Pydantic validators)
- ç±»å‹æç¤ºæ›´æ¸…æ™°

### 3.2 Middleware - âœ… æ¨è

**å½“å‰é—®é¢˜**: CORSã€å¼‚å¸¸å¤„ç†ã€è®¤è¯é€»è¾‘æ•£è½åœ¨ main.py ä¸­

**å»ºè®®ç»“æ„**:
```
middleware/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ cors.py           # CORS ä¸­é—´ä»¶é…ç½®
â”œâ”€â”€ errors.py         # å…¨å±€å¼‚å¸¸å¤„ç†å™¨
â”œâ”€â”€ auth.py           # è®¤è¯é€»è¾‘ (ä» auth.py è¿ç§»)
â”œâ”€â”€ logging.py        # è¯·æ±‚/å“åº”æ—¥å¿—
â””â”€â”€ rate_limit.py    # é™æµä¸­é—´ä»¶
```

**ä¸ºä»€ä¹ˆéœ€è¦ Middleware**:
- é›†ä¸­ç®¡ç†è·¨åˆ‡é¢é€»è¾‘
- ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
- æ˜“äºæ›¿æ¢å’Œæµ‹è¯•
- FastAPI åŸç”Ÿæ”¯æŒ

### 3.3 Common - âœ… æ¨è

**å½“å‰é—®é¢˜**: errors.py, logger.py, utils.py, prompts.py æ··åœ¨æ ¹ç›®å½•

**å»ºè®®ç»“æ„**:
```
common/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ errors.py         # APIError, ErrorCode, create_error_response
â”œâ”€â”€ logger.py        # æ—¥å¿—é…ç½® (å¯ç›´æ¥è¿ç§»)
â”œâ”€â”€ responses.py     # ç»Ÿä¸€å“åº”æ ¼å¼
â”œâ”€â”€ utils.py        # é€šç”¨å·¥å…·å‡½æ•°
â”œâ”€â”€ prompts.py      # æç¤ºè¯æ¨¡æ¿
â””â”€â”€ constants.py   # å¸¸é‡å®šä¹‰
```

**ä¸ºä»€ä¹ˆéœ€è¦ Common**:
- å‡å°‘ä»£ç é‡å¤
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- ä¾¿äºå…¨å±€é…ç½®

### 3.4 å®Œæ•´æ¨èç›®å½•ç»“æ„

```
assets/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ health.py
â”‚       â”œâ”€â”€ chats.py
â”‚       â”œâ”€â”€ knowledge.py
â”‚       â”œâ”€â”€ sources.py
â”‚       â”œâ”€â”€ rag.py
â”‚       â”œâ”€â”€ admin.py
â”‚       â”œâ”€â”€ config.py
â”‚       â”œâ”€â”€ upload.py
â”‚       â””â”€â”€ websocket.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat_service.py
â”‚   â”œâ”€â”€ rag_service.py
â”‚   â”œâ”€â”€ knowledge_service.py
â”‚   â””â”€â”€ health_service.py
â”œâ”€â”€ dto/                    # â­ æ–°å¢ - æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat_dto.py
â”‚   â”œâ”€â”€ rag_dto.py
â”‚   â”œâ”€â”€ knowledge_dto.py
â”‚   â”œâ”€â”€ common_dto.py
â”‚   â””â”€â”€ admin_dto.py
â”œâ”€â”€ middleware/             # â­ æ–°å¢ - ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cors.py
â”‚   â”œâ”€â”€ errors.py
â”‚   â”œâ”€â”€ auth.py
â”‚   â””â”€â”€ logging.py
â”œâ”€â”€ common/                 # â­ æ–°å¢ - é€šç”¨æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ errors.py
â”‚   â”œâ”€â”€ logger.py
â”‚   â”œâ”€â”€ responses.py
â”‚   â”œâ”€â”€ utils.py
â”‚   â”œâ”€â”€ prompts.py
â”‚   â””â”€â”€ constants.py
â”œâ”€â”€ dependencies/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ providers.py
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ milvus_client.py    # ä» vector_store.py è¿ç§»
â”‚   â”œâ”€â”€ postgres_client.py # ä» postgres_storage.py è¿ç§»
â”‚   â”œâ”€â”€ cache.py           # ç»Ÿä¸€ç¼“å­˜å±‚
â”‚   â””â”€â”€ observability.py   # å¯è§‚æµ‹æ€§
â””â”€â”€ main.py                 # æœ€ç»ˆç›®æ ‡ < 500 è¡Œ
```

---

## å››ã€é‡æ„é“ºå«æ¸…å•

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€è®¾æ–½æ­å»º

| ä»»åŠ¡ | æè¿° | äº§å‡ºæ–‡ä»¶ |
|------|------|----------|
| T1.1 | åˆ›å»ºç›®å½•ç»“æ„ | `app/`, `services/`, `dto/`, `middleware/`, `common/`, `dependencies/`, `infrastructure/` |
| T1.2 | è¿ç§»é€šç”¨æ¨¡å— | `common/errors.py`, `common/logger.py`, `common/responses.py` |
| T1.3 | åˆ›å»ºä¾èµ–æ³¨å…¥æ¡†æ¶ | `dependencies/providers.py` |
| T1.4 | åˆ›å»º Pydantic DTO | `dto/chat_dto.py`, `dto/rag_dto.py`, `dto/common_dto.py` |

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šè·¯ç”±æ‹†åˆ†

| ä¼˜å…ˆçº§ | è·¯ç”± | ç›®æ ‡æ–‡ä»¶ | å·¥ä½œé‡ |
|--------|------|----------|--------|
| **P0** | `/health`, `/health/rag`, `/metrics` | `routers/health.py` | 0.5å¤© |
| **P0** | `/chats`, `/chat/{id}`, `/chat/new` | `routers/chats.py` | 1å¤© |
| **P1** | `/sources/*`, `/knowledge/*` | `routers/sources.py`, `routers/knowledge.py` | 1.5å¤© |
| **P1** | `/rag/*`, `/test/*` | `routers/rag.py` | 1å¤© |
| **P2** | `/config/*`, `/selected_*` | `routers/config.py` | 0.5å¤© |
| **P2** | `/admin/*` | `routers/admin.py` | 1å¤© |
| **P3** | `/ws/*`, `/upload-*`, `/ingest` | `routers/websocket.py`, `routers/upload.py` | 1.5å¤© |

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šService å±‚æå–

| ä»»åŠ¡ | æè¿° | ç›®æ ‡æ–‡ä»¶ |
|------|------|----------|
| T3.1 | æå–èŠå¤©ä¸šåŠ¡é€»è¾‘ | `services/chat_service.py` |
| T3.2 | æå– RAG ä¸šåŠ¡é€»è¾‘ | `services/rag_service.py` |
| T3.3 | æå–çŸ¥è¯†åº“ä¸šåŠ¡é€»è¾‘ | `services/knowledge_service.py` |
| T3.4 | æå–å¥åº·æ£€æŸ¥ä¸šåŠ¡é€»è¾‘ | `services/health_service.py` |

### 4.4 ç¬¬å››é˜¶æ®µï¼šåŸºç¡€è®¾æ–½å°è£…

| ä»»åŠ¡ | æè¿° | ç›®æ ‡æ–‡ä»¶ |
|------|------|----------|
| T4.1 | å°è£… Milvus å®¢æˆ·ç«¯ | `infrastructure/milvus_client.py` |
| T4.2 | å°è£… PostgreSQL å®¢æˆ·ç«¯ | `infrastructure/postgres_client.py` |
| T4.3 | ç»Ÿä¸€ç¼“å­˜å±‚ | `infrastructure/cache.py` |
| T4.4 | å¯è§‚æµ‹æ€§é›†æˆ | `infrastructure/observability.py` |

---

## äº”ã€é‡æ„é£é™©è¯„ä¼°

### 5.1 é«˜é£é™©é¡¹

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| ç ´åç°æœ‰åŠŸèƒ½ | å¯èƒ½å½±å“ç”Ÿäº§ | å®Œæ•´æµ‹è¯•è¦†ç›– |
| å…¨å±€å˜é‡ä¾èµ– | è¿ç§»å›°éš¾ | é€æ­¥æ›¿æ¢ |
| WebSocket çŠ¶æ€ | è¿æ¥ä¸­æ–­ | ä»”ç»†éªŒè¯ |
| pymilvus æ•£è½ | éš¾ä»¥è¿½è¸ª | å…¨é¢æœç´¢ |

### 5.2 ä¸­é£é™©é¡¹

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| å¾ªç¯ä¾èµ– | å¯¼å…¥é”™è¯¯ | ä»”ç»†è®¾è®¡æ¶æ„ |
| æ€§èƒ½ä¸‹é™ | å“åº”å˜æ…¢ | åŸºå‡†æµ‹è¯• |
| API å…¼å®¹ | å‰ç«¯éœ€æ”¹ | ä¿æŒå…¼å®¹ |

---

## å…­ã€Claude Code å¤§é¡¹ç›®å¤„ç†æœ€ä½³å®è·µ


### 6.1 ç†è§£ä¸Šä¸‹æ–‡é™åˆ¶

Claude Code ä½¿ç”¨æœ‰é™ "ä¸Šä¸‹æ–‡çª—å£" çš„å¤§å‹è¯­è¨€æ¨¡å‹ã€‚è¿™æ˜¯æ¨¡å‹ä¸€æ¬¡å¯ä»¥å¤„ç†çš„æœ€å¤§æ–‡æœ¬é‡ (ä»¥ token æµ‹é‡)ã€‚

**ä¸Šä¸‹æ–‡çª—å£åŒ…å«**:
- ç³»ç»Ÿæç¤ºè¯ (Claude Code çš„æŒ‡ä»¤)
- å¯¹è¯å†å²
- ä½¿ç”¨ `@` å¼•ç”¨çš„æ–‡ä»¶å†…å®¹
- ä»»ä½•å‘½ä»¤æˆ–å·¥å…·çš„è¾“å‡º

### 6.2 ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

1. **å…·ä½“æ˜ç¡®**: å¼•ç”¨æ–‡ä»¶æˆ–ä»£ç æ—¶ï¼Œä½¿ç”¨å…·ä½“æ–‡ä»¶è·¯å¾„å’Œå‡½æ•°åã€‚é¿å…æ¨¡ç³Šå¼•ç”¨å¦‚ "main æ–‡ä»¶"

2. **æœ‰æ•ˆä½¿ç”¨ä¸Šä¸‹æ–‡æåŠ**:
   - ä½¿ç”¨ `@/path/to/file.py` åŒ…å«ç‰¹å®šæ–‡ä»¶
   - ä½¿ç”¨ `@problems` åŒ…å«å½“å‰é”™è¯¯å’Œè­¦å‘Š
   - ä½¿ç”¨ `@` + æäº¤å“ˆå¸Œå¼•ç”¨ç‰¹å®š Git æäº¤

3. **åˆ†è§£ä»»åŠ¡**: å°†å¤§å‹ä»»åŠ¡åˆ†è§£ä¸ºæ›´å°ã€å¯ç®¡ç†çš„å­ä»»åŠ¡ã€‚è¿™æœ‰åŠ©äºä¿æŒä¸Šä¸‹æ–‡èšç„¦

4. **æ€»ç»“**: å¦‚æœéœ€è¦å¼•ç”¨å¤§é‡ä»£ç ,è€ƒè™‘æ€»ç»“ç›¸å…³éƒ¨åˆ†è€Œä¸æ˜¯åŒ…å«æ•´ä¸ªä»£ç 

5. **ä¼˜å…ˆå¤„ç†æœ€è¿‘çš„å†å²**: Claude Code ä¼šè‡ªåŠ¨æˆªæ–­æ—§æ¶ˆæ¯ä»¥ä¿æŒåœ¨ä¸Šä¸‹æ–‡çª—å£å†…ã€‚æ³¨æ„è¿™ä¸€ç‚¹,å¦‚éœ€è¦é‡æ–°åŒ…å«é‡è¦ä¸Šä¸‹æ–‡

6. **ä½¿ç”¨æç¤ºè¯ç¼“å­˜** (å¦‚æœå¯ç”¨): æŸäº› API æä¾›å•†å¦‚ Anthropicã€OpenAIã€OpenRouter å’Œ Requesty æ”¯æŒ "æç¤ºè¯ç¼“å­˜"

### 6.3 å¤§æ–‡ä»¶é‡æ„ç¤ºä¾‹

å‚è€ƒ Roo Code å®˜æ–¹ç¤ºä¾‹ï¼Œé‡æ„å¤§æ–‡ä»¶æ—¶ï¼š

1. **åˆå§‹æ¦‚è§ˆ**:
   ```
   @/src/components/MyComponent.tsx åˆ—å‡ºè¿™ä¸ªæ–‡ä»¶ä¸­çš„å‡½æ•°å’Œç±»
   ```

2. **é’ˆå¯¹ç‰¹å®šå‡½æ•°**:
   ```
   @/src/components/MyComponent.tsx é‡æ„ `processData` å‡½æ•°ï¼Œä½¿ç”¨ async/await ä»£æ›¿ Promises
   ```

3. **å¢é‡æ›´æ”¹**: è¿›è¡Œå°çš„å¢é‡æ›´æ”¹ï¼Œå®¡æŸ¥å¹¶æ‰¹å‡†æ¯ä¸€æ­¥

### 6.4 æœ¬é¡¹ç›®åº”ç”¨ç­–ç•¥

**å¯¹äº main.py (2280 è¡Œ)**:

1. **ä½¿ç”¨ä¸Šä¸‹æ–‡æåŠ**: å§‹ç»ˆä½¿ç”¨å…·ä½“è¡Œå·ï¼Œå¦‚ `@/main.py:154-241` å¼•ç”¨å¥åº·æ£€æŸ¥è·¯ç”±

2. **åˆ†é˜¶æ®µé‡æ„**: æ¯ä¸ªè·¯ç”±å•ç‹¬è¿ç§»ï¼Œä¸è¦ä¸€æ¬¡æ€§è¿ç§»æ•´ä¸ªæ–‡ä»¶

3. **å¢é‡éªŒè¯**: æ¯è¿ç§»ä¸€ä¸ªè·¯ç”±ï¼ŒéªŒè¯åŠŸèƒ½æ­£å¸¸

4. **ä¿æŒä¸Šä¸‹æ–‡èšç„¦**: æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªæ¨¡å— (å¦‚ health.py æˆ– chats.py)

---

## ä¸ƒã€æ‰§è¡Œæ£€æŸ¥æ¸…å•

### 7.1 å¼€å§‹ä¹‹å‰

- [ ] å¤‡ä»½å½“å‰ä»£ç  (Git)
- [ ] åˆ›å»ºé‡æ„åˆ†æ”¯
- [ ] ç¡®å®šæµ‹è¯•ç¯å¢ƒ
- [ ] è®°å½•å½“å‰ API ç«¯ç‚¹

### 7.2 æ¯ä¸ªä»»åŠ¡ä¹‹å

- [ ] è¿è¡Œè¯­æ³•æ£€æŸ¥: `python -m py_compile`
- [ ] è¿è¡Œå¯¼å…¥æ£€æŸ¥: `python -c "from app.routers import health"`
- [ ] æµ‹è¯•å¥åº·æ£€æŸ¥: `curl http://localhost:8000/health`
- [ ] éªŒè¯æ ¸å¿ƒåŠŸèƒ½

### 7.3 é‡æ„å®Œæˆæ—¶

- [ ] main.py < 500 è¡Œ
- [ ] æ‰€æœ‰è·¯ç”±ä½¿ç”¨ä¾èµ–æ³¨å…¥
- [ ] ç»Ÿä¸€å“åº”æ ¼å¼
- [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

## å…«ã€å¿«é€Ÿå¼€å§‹æç¤ºè¯

### æç¤ºè¯ 1: åˆ›å»ºç›®å½•ç»“æ„

```markdown
# åˆ›å»ºé‡æ„ç›®å½•ç»“æ„

è¯·åœ¨ `dgx-spark-playbooks/nvidia/multi-agent-chatbot/assets/backend/` ä¸‹åˆ›å»ºä»¥ä¸‹ç›®å½•ç»“æ„ï¼š

```
assets/backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ health.py
â”‚       â”œâ”€â”€ chats.py
â”‚       â”œâ”€â”€ knowledge.py
â”‚       â”œâ”€â”€ sources.py
â”‚       â”œâ”€â”€ rag.py
â”‚       â”œâ”€â”€ admin.py
â”‚       â”œâ”€â”€ config.py
â”‚       â”œâ”€â”€ upload.py
â”‚       â””â”€â”€ websocket.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat_service.py
â”‚   â”œâ”€â”€ rag_service.py
â”‚   â”œâ”€â”€ knowledge_service.py
â”‚   â””â”€â”€ health_service.py
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ chat_dto.py
â”‚   â”œâ”€â”€ rag_dto.py
â”‚   â”œâ”€â”€ knowledge_dto.py
â”‚   â”œâ”€â”€ common_dto.py
â”‚   â””â”€â”€ admin_dto.py
â”œâ”€â”€ middleware/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ cors.py
â”‚   â”œâ”€â”€ errors.py
â”‚   â”œâ”€â”€ auth.py
â”‚   â””â”€â”€ logging.py
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ errors.py
â”‚   â”œâ”€â”€ responses.py
â”‚   â”œâ”€â”€ utils.py
â”‚   â”œâ”€â”€ prompts.py
â”‚   â””â”€â”€ constants.py
â”œâ”€â”€ dependencies/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ providers.py
â””â”€â”€ infrastructure/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ milvus_client.py
    â””â”€â”€ postgres_client.py
```

å‚è€ƒ: Claude Code å¤§é¡¹ç›®å¤„ç†æœ€ä½³å®è·µ
```

### æç¤ºè¯ 2: è¿ç§»å¥åº·æ£€æŸ¥è·¯ç”±

```markdown
# è¿ç§»å¥åº·æ£€æŸ¥è·¯ç”±

è¯·å°† main.py ä¸­çš„å¥åº·æ£€æŸ¥è·¯ç”±è¿ç§»åˆ° `app/routers/health.py`ã€‚

æºæ–‡ä»¶: `dgx-spark-playbooks/nvidia/multi-agent-chatbot/assets/backend/main.py`
æºè¡Œå·: 154-241 (GET /health), 243-290 (GET /health/rag), 293-336 (GET /metrics)

è¦æ±‚ï¼š
1. ä½¿ç”¨ FastAPI Router
2. ä¿æŒç°æœ‰ä¸šåŠ¡é€»è¾‘
3. ä½¿ç”¨ç»Ÿä¸€å“åº”æ ¼å¼ from `common.responses`
4. ä¸è¦ä½¿ç”¨å…¨å±€å˜é‡ï¼Œä½¿ç”¨ä¾èµ–æ³¨å…¥

é¦–å…ˆè¯·é˜…è¯»æºæ–‡ä»¶ï¼Œç„¶ååˆ›å»ºæ–°æ–‡ä»¶ã€‚
```

---

## ä¹ã€å‚è€ƒèµ„æº

### Claude Code å®˜æ–¹æŒ‡å—
- [Claude Prompting æœ€ä½³å®è·µ](https://platform.claude.ai/docs/en/build-with-claude/prompt-engineering/claude-prompting-best-practices)

### ç›®å½•ç»“æ„å‚è€ƒ
- FastAPI å®˜æ–¹æ¨è: https://fastapi.tiangolo.com/tutorial/bigger-applications/
- Python é¡¹ç›®æœ€ä½³å®è·µ: https://packaging.python.org/en/latest/tutorials/packaging-projects/

---
